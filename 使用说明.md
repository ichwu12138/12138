## 使用说明

### 1. 环境准备与启动
   - 确保已安装Python和上述依赖库。建议使用虚拟环境。
   - 创建 `requirements.txt` 文件并执行 `pip install -r requirements.txt`。
   - 运行命令:
     ```bash
     python app_tk.py
     ```

### 2. 基本操作流程
1.  **启动程序**：首次启动会依次提示选择界面语言和主题。
2.  **加载初始数据（可选）**：程序会询问是否加载上次使用的配置文件、BOM文件以及上次未导出的逻辑规则。
3.  **导入配置文件**：在左侧"配置选项"面板，点击"导入配置"按钮，选择包含特征码和特征值的Excel文件。
4.  **导入BOM文件**：在右侧"BOM"面板，点击"导入BOM"按钮，选择包含BOM结构信息的Excel文件。
5.  **创建逻辑规则**：
    *   在中间"逻辑编辑"面板，通过点击按钮或从左右面板双击来构建"选择项表达式"。
    *   点击"→"按钮。
    *   构建"影响项表达式"（可以是BOM码，或使用下方的微调逻辑构建器生成）。
    *   选择规则状态（启用、测试、禁用）。
    *   点击"保存规则"。规则将显示在下方的"已保存规则"列表中。
6.  **管理逻辑规则**：
    *   通过菜单"视图" -> "逻辑关系库"打开规则库。
    *   在规则库中可以搜索、编辑（包括标签和技术文档）、删除或更改规则状态。
7.  **导出规则**：通过菜单"文件" -> "导出逻辑规则"将所有规则保存到JSON文件。
8.  **导入规则**：通过菜单"文件" -> "导入逻辑规则"从JSON文件加载规则。

### 3. 逻辑规则格式
- **基本格式**：`选择项表达式 → 影响项表达式`
- **选择项表达式 (IF part)**：
  - 由一个或多个特征值 (K码，如 `K-200-000000`) 组成。
  - 可以使用 `AND`, `OR`, `NOT` 连接。
  - 可以使用 `()` 进行分组。
  - 示例：`K-200-000000 AND (K-200-000300 OR NOT K-200-000169)`
- **影响项表达式 (THEN part)**：
  - **BOM替换逻辑**：直接指定一个BOM码。
    - 示例：`PL-GrundKabine-10019232`
  - **微调逻辑**：对现有BOM进行修改。
    - `ON <BOM码1> ADD <BOM码2>`：在BOM码1下增加BOM码2。
    - `FROM <BOM码1> DELETE <BOM码2>`：从BOM码1下删除BOM码2。
    - `CHANGE QUANTITY OF <BOM码> TO <数量>`：改变BOM码的数量。
    - `CHANGE PRICE <价格变动>`：改变价格（如 `+100`, `-50`）。
    - 示例：`ON 10019231 ADD 357921`

### 4. 数据文件要求
- **配置选项Excel (`Kabinemekrmal(Test).xlsx` 类型)**：
  - 工作表名称应包含数字编号和名称，如 `1. Allgemein`。模块ID会基于此生成。
  - 跳过名为 "0.模板&Vorlage", "TD" 或首字符非数字的工作表。
  - 必需列：`特征值/Merkmalwert`, `特征/Merkmale`, `特征值名称/Merkmalwertname`。
  - 特征码 (F码) 应符合 `HBG_xxx_xxx` 格式。
  - 特征值 (K码) 应符合 `K-xxx-xxxxxx` 格式。

- **BOM Excel (`Bom.xlsx` 类型)**：
  - 必须包含名为 `Max-Gruppe` 的工作表。
  - 必需列：`Auflösungsstufe` (层级), `Placeholder` (占位符), `Baugruppe` (组件), `Objektkurztext` (短文本/名称), `Langtext` (长文本, 可选)。
  - `Auflösungsstufe` 为空或 `Baugruppe` 为空的行会被忽略或特殊处理。

## 注意事项

1.  **数据安全与备份**:
    *   强烈建议定期使用"导出逻辑规则"功能备份您的规则到安全的JSON文件。
    *   程序会自动将当前未导出的规则保存到 `data/temp_rules_latest.json`，但此文件主要用于程序非正常关闭后的恢复，不应作为长期备份。
    *   在执行导入规则等可能覆盖现有数据的操作前，程序会提示确认。

2.  **文件路径**:
    *   程序会记住上次成功导入的配置文件和BOM文件的路径，并在下次启动时询问是否加载。
    *   技术文档关联存储的是绝对路径，如果文件移动，关联会失效。

3.  **性能考虑**:
    *   导入大型Excel文件（尤其是BOM文件）可能需要一些时间，请耐心等待。
    *   逻辑表达式的验证主要在保存规则时进行，复杂的表达式可能会略微增加保存时间。

4.  **日志文件**:
    *   日志文件位于 `logs/` 目录下，按日期命名。旧的日志文件会根据配置自动清理（具体策略需查看 `utils/logger.py`）。
    *   如果程序出现异常，日志文件是排查问题的重要依据。

## 已知限制
-   技术文档关联功能仅支持本地文件路径，不支持URL或网络共享路径的直接访问（除非已映射为本地驱动器）。
-   规则编辑目前主要在"逻辑关系库"中进行，逻辑编辑面板下方的列表主要用于展示当前会话中新增或刚导入的规则，其编辑功能有限。

## 错误处理与排查

如果遇到问题或程序行为不符合预期：
1.  **查看界面提示**：程序通常会通过对话框给出错误信息。
2.  **检查日志文件**：打开 `logs/` 目录下最新的日志文件，查找ERROR或CRITICAL级别的日志。
3.  **验证输入数据**：
    *   确保导入的Excel文件格式符合"数据文件要求"部分的描述。
    *   检查逻辑表达式是否符合"逻辑规则格式"部分的描述。
4.  **检查配置文件**：查看 `data/app_config.json` 和 `data/temp_rules_latest.json` 是否损坏（例如，非法的JSON格式）。
5.  **环境问题**：确认Python版本和所有依赖库已正确安装且版本兼容。

## 技术支持
(这部分可以根据您的实际情况填写，例如联系方式或问题提交通道)
